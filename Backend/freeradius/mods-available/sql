# SQL Module Configuration for PostgreSQL
sql {
    driver = "rlm_sql_postgresql"
    dialect = "postgresql"
    
    # Connection info
    server = "${env:DB_HOST:-postgres}"
    port = ${env:DB_PORT:-5432}
    login = "${env:DB_USER:-postgres}"
    password = "${env:DB_PASSWORD:-cvkcvk12}"
    radius_db = "${env:DB_NAME:-rtrwnet_saas}"
    
    # Connection pool
    pool {
        start = 2
        min = 2
        max = 10
        spare = 1
        uses = 0
        retry_delay = 30
        lifetime = 0
        idle_timeout = 60
    }
    
    # Read NAS clients from database
    read_clients = yes
    client_table = "radius_nas"
    
    # Remove stale sessions
    delete_stale_sessions = yes
    
    # ============ QUERIES ============
    
    # Authorization
    authorize_check_query = "\
        SELECT id, username, attribute, value, op \
        FROM radcheck \
        WHERE username = '%{%{Stripped-User-Name}:-%{User-Name}}' \
        AND is_active = true"
    
    authorize_reply_query = "\
        SELECT id, username, attribute, value, op \
        FROM radreply \
        WHERE username = '%{%{Stripped-User-Name}:-%{User-Name}}' \
        AND is_active = true"
    
    group_membership_query = "\
        SELECT groupname FROM radusergroup \
        WHERE username = '%{%{Stripped-User-Name}:-%{User-Name}}' \
        ORDER BY priority"
    
    # Client/NAS query
    client_query = "\
        SELECT id, nasname, shortname, type, secret, server \
        FROM radius_nas WHERE is_active = true"
    
    # Post-Auth logging
    postauth_query = "\
        INSERT INTO radpostauth (username, pass, reply, authdate) \
        VALUES ('%{%{Stripped-User-Name}:-%{User-Name}}', \
        '%{%{User-Password}:-CHAP}', '%{reply:Packet-Type}', NOW())"
    
    # Accounting queries - using reference format for FreeRADIUS 3.x
    accounting {
        reference = "%{tolower:type.%{Acct-Status-Type}.query}"
        
        type {
            start {
                query = "\
                    INSERT INTO radacct \
                    (acctsessionid, acctuniqueid, username, nasipaddress, \
                    nasportid, nasporttype, acctstarttime, acctupdatetime, \
                    calledstationid, callingstationid, servicetype, \
                    framedprotocol, framedipaddress) \
                    VALUES \
                    ('%{Acct-Session-Id}', COALESCE(NULLIF('%{Acct-Unique-Session-Id}', ''), '%{Acct-Session-Id}-%{NAS-IP-Address}'), \
                    '%{%{Stripped-User-Name}:-%{User-Name}}', '%{NAS-IP-Address}', \
                    '%{%{NAS-Port-ID}:-%{NAS-Port}}', '%{NAS-Port-Type}', \
                    NOW(), NOW(), \
                    '%{Called-Station-Id}', '%{Calling-Station-Id}', \
                    '%{Service-Type}', '%{Framed-Protocol}', '%{Framed-IP-Address}') \
                    ON CONFLICT (acctuniqueid) DO UPDATE SET \
                    acctupdatetime = NOW(), \
                    framedipaddress = EXCLUDED.framedipaddress"
            }
            
            interim-update {
                query = "\
                    UPDATE radacct SET \
                    acctupdatetime = NOW(), \
                    acctsessiontime = %{%{Acct-Session-Time}:-0}, \
                    acctinputoctets = %{%{Acct-Input-Octets}:-0}, \
                    acctoutputoctets = %{%{Acct-Output-Octets}:-0}, \
                    framedipaddress = '%{Framed-IP-Address}' \
                    WHERE acctsessionid = '%{Acct-Session-Id}' \
                    AND username = '%{%{Stripped-User-Name}:-%{User-Name}}' \
                    AND nasipaddress = '%{NAS-IP-Address}'"
            }
            
            stop {
                query = "\
                    UPDATE radacct SET \
                    acctstoptime = NOW(), \
                    acctsessiontime = %{%{Acct-Session-Time}:-0}, \
                    acctinputoctets = %{%{Acct-Input-Octets}:-0}, \
                    acctoutputoctets = %{%{Acct-Output-Octets}:-0}, \
                    acctterminatecause = '%{Acct-Terminate-Cause}' \
                    WHERE acctsessionid = '%{Acct-Session-Id}' \
                    AND username = '%{%{Stripped-User-Name}:-%{User-Name}}' \
                    AND nasipaddress = '%{NAS-IP-Address}'"
            }
            
            accounting-on {
                query = "\
                    UPDATE radacct SET \
                    acctstoptime = NOW(), \
                    acctterminatecause = 'NAS-Reboot' \
                    WHERE acctstoptime IS NULL \
                    AND nasipaddress = '%{NAS-IP-Address}'"
            }
            
            accounting-off {
                query = "\
                    UPDATE radacct SET \
                    acctstoptime = NOW(), \
                    acctterminatecause = 'NAS-Reboot' \
                    WHERE acctstoptime IS NULL \
                    AND nasipaddress = '%{NAS-IP-Address}'"
            }
        }
    }
    
    # Post-auth section
    post-auth {
        query = "${..postauth_query}"
    }
}
