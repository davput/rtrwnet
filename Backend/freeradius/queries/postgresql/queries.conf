# PostgreSQL Queries for FreeRADIUS

# Group membership query (required for group checks)
group_membership_query = "\
    SELECT groupname \
    FROM ${usergroup_table} \
    WHERE username = '%{%{Stripped-User-Name}:-%{User-Name}}' \
    ORDER BY priority"

# Authorization Queries
authorize_check_query = "\
    SELECT id, username, attribute, value, op \
    FROM radcheck \
    WHERE username = '%{%{Stripped-User-Name}:-%{User-Name}}' \
    AND is_active = true"

authorize_reply_query = "\
    SELECT id, username, attribute, value, op \
    FROM ${authreply_table} \
    WHERE username = '%{%{Stripped-User-Name}:-%{User-Name}}' \
    AND is_active = true"

authorize_group_check_query = "\
    SELECT ${groupcheck_table}.id, ${groupcheck_table}.groupname, \
    ${groupcheck_table}.attribute, ${groupcheck_table}.op, \
    ${groupcheck_table}.value \
    FROM ${groupcheck_table}, ${usergroup_table} \
    WHERE ${usergroup_table}.username = '%{SQL-User-Name}' \
    AND ${usergroup_table}.groupname = ${groupcheck_table}.groupname \
    ORDER BY ${groupcheck_table}.id"

authorize_group_reply_query = "\
    SELECT ${groupreply_table}.id, ${groupreply_table}.groupname, \
    ${groupreply_table}.attribute, ${groupreply_table}.op, \
    ${groupreply_table}.value \
    FROM ${groupreply_table}, ${usergroup_table} \
    WHERE ${usergroup_table}.username = '%{SQL-User-Name}' \
    AND ${usergroup_table}.groupname = ${groupreply_table}.groupname \
    ORDER BY ${groupreply_table}.id"

# Accounting Queries
# Generate acctuniqueid from session+nas+user when Acct-Unique-Session-Id is not provided
accounting_start_query = "\
    INSERT INTO ${acct_table1} \
    (acctsessionid, acctuniqueid, username, realm, nasipaddress, \
    nasportid, nasporttype, acctstarttime, acctupdatetime, \
    acctstoptime, acctsessiontime, acctauthentic, connectinfo_start, \
    connectinfo_stop, acctinputoctets, acctoutputoctets, calledstationid, \
    callingstationid, acctterminatecause, servicetype, framedprotocol, \
    framedipaddress) \
    VALUES \
    ('%{Acct-Session-Id}', \
    '%{%{Acct-Unique-Session-Id}:-%{Acct-Session-Id}-%{NAS-IP-Address}-%{SQL-User-Name}}', \
    '%{SQL-User-Name}', '%{Realm}', '%{NAS-IP-Address}', \
    '%{%{NAS-Port-ID}:-%{NAS-Port}}', '%{NAS-Port-Type}', \
    TO_TIMESTAMP(%{integer:Event-Timestamp}), \
    TO_TIMESTAMP(%{integer:Event-Timestamp}), \
    NULL, 0, '%{Acct-Authentic}', '%{Connect-Info}', '', \
    0, 0, '%{Called-Station-Id}', '%{Calling-Station-Id}', '', \
    '%{Service-Type}', '%{Framed-Protocol}', \
    '%{Framed-IP-Address}')"

accounting_start_query_alt = "\
    UPDATE ${acct_table1} \
    SET acctstarttime = TO_TIMESTAMP(%{integer:Event-Timestamp}), \
    acctupdatetime = TO_TIMESTAMP(%{integer:Event-Timestamp}), \
    connectinfo_start = '%{Connect-Info}' \
    WHERE acctuniqueid = '%{%{Acct-Unique-Session-Id}:-%{Acct-Session-Id}-%{NAS-IP-Address}-%{SQL-User-Name}}'"

accounting_update_query = "\
    UPDATE ${acct_table1} \
    SET framedipaddress = '%{Framed-IP-Address}', \
    acctupdatetime = TO_TIMESTAMP(%{integer:Event-Timestamp}), \
    acctsessiontime = %{%{Acct-Session-Time}:-0}, \
    acctinputoctets = %{%{Acct-Input-Gigawords}:-0}::bigint << 32 | \
    %{%{Acct-Input-Octets}:-0}::bigint, \
    acctoutputoctets = %{%{Acct-Output-Gigawords}:-0}::bigint << 32 | \
    %{%{Acct-Output-Octets}:-0}::bigint \
    WHERE acctuniqueid = '%{%{Acct-Unique-Session-Id}:-%{Acct-Session-Id}-%{NAS-IP-Address}-%{SQL-User-Name}}'"

accounting_update_query_alt = "\
    INSERT INTO ${acct_table1} \
    (acctsessionid, acctuniqueid, username, nasipaddress, \
    nasportid, nasporttype, acctstarttime, acctupdatetime, \
    framedipaddress, acctsessiontime, acctinputoctets, acctoutputoctets) \
    VALUES \
    ('%{Acct-Session-Id}', \
    '%{%{Acct-Unique-Session-Id}:-%{Acct-Session-Id}-%{NAS-IP-Address}-%{SQL-User-Name}}', \
    '%{SQL-User-Name}', '%{NAS-IP-Address}', \
    '%{%{NAS-Port-ID}:-%{NAS-Port}}', '%{NAS-Port-Type}', \
    TO_TIMESTAMP(%{integer:Event-Timestamp}), \
    TO_TIMESTAMP(%{integer:Event-Timestamp}), \
    '%{Framed-IP-Address}', \
    %{%{Acct-Session-Time}:-0}, \
    %{%{Acct-Input-Gigawords}:-0}::bigint << 32 | %{%{Acct-Input-Octets}:-0}::bigint, \
    %{%{Acct-Output-Gigawords}:-0}::bigint << 32 | %{%{Acct-Output-Octets}:-0}::bigint)"

accounting_stop_query = "\
    UPDATE ${acct_table1} \
    SET acctstoptime = TO_TIMESTAMP(%{integer:Event-Timestamp}), \
    acctsessiontime = %{%{Acct-Session-Time}:-0}, \
    acctinputoctets = %{%{Acct-Input-Gigawords}:-0}::bigint << 32 | \
    %{%{Acct-Input-Octets}:-0}::bigint, \
    acctoutputoctets = %{%{Acct-Output-Gigawords}:-0}::bigint << 32 | \
    %{%{Acct-Output-Octets}:-0}::bigint, \
    acctterminatecause = '%{Acct-Terminate-Cause}', \
    connectinfo_stop = '%{Connect-Info}' \
    WHERE acctuniqueid = '%{%{Acct-Unique-Session-Id}:-%{Acct-Session-Id}-%{NAS-IP-Address}-%{SQL-User-Name}}'"

# Post-Auth Query
postauth_query = "\
    INSERT INTO ${postauth_table} \
    (username, pass, reply, authdate) \
    VALUES \
    ('%{SQL-User-Name}', '%{%{User-Password}:-%{Chap-Password}}', \
    '%{reply:Packet-Type}', NOW())"

# Client Query (NAS)
client_query = "\
    SELECT id, nasname, shortname, type, secret, server \
    FROM ${client_table} \
    WHERE is_active = true"
